<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eso-Forum üåø</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- Font Awesome pour les ic√¥nes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4a6f28;
            --secondary: #8ba888;
            --light: #f1f8e9;
            --dark: #2c3e50;
            --accent: #e67e22;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
            color: var(--dark);
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        h2 {
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 8px;
            margin-top: 30px;
        }
        /* Section Authentification */
        .auth-forms {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .auth-form {
            flex: 1;
            min-width: 280px;
            padding: 25px;
            background: var(--light);
            border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        input:focus {
            border-color: var(--primary);
            outline: none;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s, transform 0.2s;
        }
        button:hover {
            background: #3a5a20;
            transform: translateY(-2px);
        }
        button.secondary {
            background: var(--secondary);
        }
        /* Section Utilisateur */
        #user-status {
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 500;
        }
        #user-status a {
            color: var(--accent);
            text-decoration: none;
            font-weight: bold;
        }
        /* Section Commentaires */
        #comments-section {
            margin-top: 40px;
        }
        .comments-container {
            margin-top: 20px;
        }
        .comment {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .comment-author {
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .comment-author i {
            color: var(--accent);
        }
        .comment-timestamp {
            font-size: 0.8rem;
            color: #777;
            margin-left: 10px;
        }
        .comment-text {
            margin: 15px 0;
            padding-left: 10px;
            border-left: 3px solid var(--secondary);
        }
        .comment-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .comment-actions button {
            padding: 6px 12px;
            font-size: 0.9rem;
            background: transparent;
            color: var(--dark);
            border: 1px solid #ddd;
        }
        .comment-actions button:hover {
            background: var(--light);
        }
        .comment-actions button.liked {
            color: #e74c3c;
        }
        .comment-actions button.liked i {
            color: #e74c3c;
        }
        .reply-form {
            margin-top: 15px;
            padding-left: 30px;
            border-left: 2px dashed var(--secondary);
        }
        .replies-container {
            margin-top: 20px;
            padding-left: 30px;
        }
        .reply {
            background: #f9f9f9;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }
        /* Formulaire principal */
        #comment-form {
            background: var(--light);
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
        }
        #comment-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
        }
        /* Chat priv√© */
        #private-chat-section {
            margin-top: 40px;
        }
        #users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .user-card {
            background: var(--light);
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-card:hover {
            background: var(--secondary);
            color: white;
        }
        .user-card.online {
            border-left: 4px solid #2ecc71;
        }
        .user-card.offline {
            opacity: 0.7;
        }
        .user-card .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .user-card.online .status-dot {
            background: #2ecc71;
        }
        .user-card.offline .status-dot {
            background: #95a5a6;
        }
        #chat-container {
            display: none;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        #chat-header {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: white;
        }
        .message {
            margin-bottom: 15px;
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
        }
        .message.sent {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .message.received {
            background: #f1f1f1;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .message-info {
            font-size: 0.8rem;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        #chat-input-container {
            display: flex;
            border-top: 1px solid #ddd;
            background: var(--light);
        }
        #chat-input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 0;
        }
        #send-chat-btn {
            border-radius: 0;
        }
        /* Classes utilitaires */
        .hidden {
            display: none !important;
        }
        .text-center {
            text-align: center;
        }
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .comment, .reply, .message {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-leaf"></i>Eso-Forum</h1>
        
        <!-- √âtat de connexion -->
        <div id="user-status">Chargement...</div>

        <!-- Formulaires Auth -->
        <div class="auth-forms" id="auth-forms">
            <div class="auth-form">
                <h2><i class="fas fa-user-plus"></i> Inscription</h2>
                <input type="email" id="signup-email" placeholder="Votre email">
                <input type="password" id="signup-password" placeholder="Mot de passe (6+ caract√®res)">
                <button onclick="signUp()"><i class="fas fa-user-edit"></i> S'inscrire</button>
            </div>
            <div class="auth-form">
                <h2><i class="fas fa-sign-in-alt"></i> Connexion</h2>
                <input type="email" id="login-email" placeholder="Votre email">
                <input type="password" id="login-password" placeholder="Mot de passe">
                <button onclick="signIn()"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
            </div>
        </div>

        <!-- Section Commentaires -->
        <div id="comments-section" class="hidden">
            <h2><i class="fas fa-comments"></i> Discussions</h2>
            <div id="comments-container" class="comments-container"></div>
            
            <form id="comment-form">
                <h3><i class="fas fa-edit"></i> Nouveau commentaire</h3>
                <textarea id="comment-input" placeholder="Partagez vos connaissances en botanique √©sot√©rique..."></textarea>
                <button type="button" onclick="postComment()"><i class="fas fa-paper-plane"></i> Publier</button>
            </form>
        </div>

        <!-- Section Chat Priv√© -->
        <div id="private-chat-section" class="hidden">
            <h2><i class="fas fa-comment-dots"></i> Messages Priv√©s</h2>
            <p>Discutez en priv√© avec d'autres membres (seulement pour les utilisateurs connect√©s)</p>
            
            <h3>Membres en ligne</h3>
            <div id="users-list"></div>
            
            <div id="chat-container">
                <div id="chat-header">
                    <span id="chat-with-user">Discussion avec <span id="current-chat-user"></span></span>
                    <button onclick="closeChat()" class="secondary"><i class="fas fa-times"></i></button>
                </div>
                <div id="chat-messages"></div>
                <div id="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Tapez votre message...">
                    <button id="send-chat-btn" onclick="sendPrivateMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBdVFpZ5xwM90QZMIMC9m8jrTaLNqN_bI4",
            authDomain: "connection-5392f.firebaseapp.com",
            projectId: "connection-5392f",
            storageBucket: "connection-5392f.appspot.com",
            messagingSenderId: "157508792872",
            appId: "1:157508792872:web:23987228dfa3facf627b1d"
        };

        // Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables globales
        let currentReplyTo = null;
        let currentChatWith = null;
        let usersOnline = {};
        let userStatusRef = null;
        let currentUserEmail = null;

        // ===== AUTHENTIFICATION =====
        function signUp() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    alert("Bienvenue dans la communaut√© Eso-Botanica !");
                })
                .catch(error => {
                    alert("Erreur: " + error.message);
                });
        }

        function signIn() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    console.log("Connexion r√©ussie");
                })
                .catch(error => {
                    alert("Erreur: " + error.message);
                });
        }

        function signOut() {
            auth.signOut();
            currentReplyTo = null;
            currentChatWith = null;
        }

        // ===== GESTION DES COMMENTAIRES =====
        async function postComment() {
            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();
            
            if (!commentText) return;
            
            try {
                if (currentReplyTo) {
                    // Poste une r√©ponse
                    const replyData = {
                        text: commentText,
                        author: auth.currentUser.email,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        parentId: currentReplyTo
                    };
                    
                    await db.collection("comments").doc(currentReplyTo).collection("replies").add(replyData);
                    
                    commentInput.value = "";
                    commentInput.placeholder = "Partagez vos connaissances en botanique √©sot√©rique...";
                    currentReplyTo = null;
                } else {
                    // Poste un nouveau commentaire principal
                    const commentData = {
                        text: commentText,
                        author: auth.currentUser.email,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        likes: 0,
                        likedBy: []
                    };
                    
                    await db.collection("comments").add(commentData);
                    commentInput.value = "";
                }
            } catch (error) {
                console.error("Erreur lors de la publication: ", error);
                alert("Une erreur est survenue lors de la publication");
            }
        }

        function replyToComment(commentId, author) {
            currentReplyTo = commentId;
            const commentInput = document.getElementById('comment-input');
            commentInput.placeholder = `R√©ponse √† ${author}...`;
            commentInput.focus();
        }

        function toggleLike(commentId, currentLikes, likedBy) {
            if (!auth.currentUser) return;
            
            const userId = auth.currentUser.uid;
            const userEmail = auth.currentUser.email;
            const commentRef = db.collection("comments").doc(commentId);
            
            // V√©rifie si l'utilisateur a d√©j√† lik√©
            const userIndex = likedBy.indexOf(userEmail);
            let newLikes = currentLikes;
            let newLikedBy = [...likedBy];
            
            if (userIndex > -1) {
                // Retire le like
                newLikes--;
                newLikedBy.splice(userIndex, 1);
            } else {
                // Ajoute un like
                newLikes++;
                newLikedBy.push(userEmail);
            }
            
            // Met √† jour le commentaire
            commentRef.update({
                likes: newLikes,
                likedBy: newLikedBy
            }).catch(error => {
                console.error("Erreur lors de la mise √† jour du like: ", error);
            });
        }

        // ===== AFFICHAGE DES COMMENTAIRES =====
        function loadComments() {
            // √âcoute les commentaires principaux
            db.collection("comments")
                .orderBy("timestamp", "desc")
                .onSnapshot(snapshot => {
                    const container = document.getElementById('comments-container');
                    container.innerHTML = "";
                    
                    snapshot.forEach(doc => {
                        const comment = doc.data();
                        displayComment(doc.id, comment, container);
                        
                        // Charge les r√©ponses existantes
                        loadReplies(doc.id);
                    });
                }, error => {
                    console.error("Erreur lors du chargement des commentaires: ", error);
                });
        }

        function loadReplies(commentId) {
            db.collection("comments").doc(commentId).collection("replies")
                .orderBy("timestamp")
                .onSnapshot(snapshot => {
                    const repliesContainer = document.getElementById(`replies-${commentId}`);
                    if (repliesContainer) {
                        repliesContainer.innerHTML = "";
                        snapshot.forEach(replyDoc => {
                            const reply = replyDoc.data();
                            displayReply(reply, repliesContainer);
                        });
                    }
                }, error => {
                    console.error("Erreur lors du chargement des r√©ponses: ", error);
                });
        }

        function displayComment(id, comment, container) {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            commentElement.id = `comment-${id}`;
            
            const isLiked = auth.currentUser && comment.likedBy && comment.likedBy.includes(auth.currentUser.email);
            
            commentElement.innerHTML = `
                <div class="comment-author">
                    <i class="fas fa-user"></i>
                    ${comment.author}
                    <span class="comment-timestamp">${formatDate(comment.timestamp)}</span>
                </div>
                <div class="comment-text">${comment.text}</div>
                <div class="comment-actions">
                    <button onclick="toggleLike('${id}', ${comment.likes || 0}, ${JSON.stringify(comment.likedBy || [])})" 
                            class="${isLiked ? 'liked' : ''}">
                        <i class="fas fa-heart"></i> J'aime (${comment.likes || 0})
                    </button>
                    <button onclick="replyToComment('${id}', '${comment.author}')">
                        <i class="fas fa-reply"></i> R√©pondre
                    </button>
                    ${auth.currentUser && comment.author !== auth.currentUser.email ? 
                      `<button onclick="startPrivateChat('${comment.author}')">
                        <i class="fas fa-comment-dots"></i> Message priv√©
                      </button>` : ''}
                </div>
                <div id="replies-${id}" class="replies-container"></div>
            `;
            container.appendChild(commentElement);
        }

        function displayReply(reply, container) {
            const replyElement = document.createElement('div');
            replyElement.className = 'reply';
            replyElement.innerHTML = `
                <div class="comment-author">
                    <i class="fas fa-user"></i>
                    ${reply.author}
                    <span class="comment-timestamp">${formatDate(reply.timestamp)}</span>
                </div>
                <div class="comment-text">${reply.text}</div>
            `;
            container.appendChild(replyElement);
        }

        function formatDate(timestamp) {
            if (!timestamp) return "maintenant";
            const date = timestamp.toDate();
            return date.toLocaleString('fr-FR', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ===== CHAT PRIV√â =====
        function loadOnlineUsers() {
            // √âcoute les changements de statut des utilisateurs
            db.collection("status")
                .where("state", "==", "online")
                .onSnapshot(snapshot => {
                    usersOnline = {};
                    snapshot.forEach(doc => {
                        if (doc.id !== currentUserEmail) {
                            usersOnline[doc.id] = doc.data();
                        }
                    });
                    updateUsersList();
                });
        }

        function updateUsersList() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            // Ajoute les utilisateurs en ligne
            Object.keys(usersOnline).forEach(email => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card online';
                userCard.innerHTML = `
                    <span class="status-dot"></span>
                    <span>${email}</span>
                `;
                userCard.onclick = () => startPrivateChat(email);
                usersList.appendChild(userCard);
            });
            
            // Si pas d'utilisateurs en ligne
            if (Object.keys(usersOnline).length === 0) {
                usersList.innerHTML = '<p>Aucun autre utilisateur en ligne pour le moment.</p>';
            }
        }

        function startPrivateChat(email) {
            currentChatWith = email;
            document.getElementById('current-chat-user').textContent = email;
            document.getElementById('chat-container').style.display = 'block';
            document.getElementById('chat-input').focus();
            
            // Charge les messages existants
            loadPrivateMessages();
        }

        function closeChat() {
            currentChatWith = null;
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('chat-messages').innerHTML = '';
        }

        function loadPrivateMessages() {
            if (!currentChatWith) return;
            
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            // Cr√©e un ID de conversation unique bas√© sur les emails tri√©s
            const chatId = [currentUserEmail, currentChatWith].sort().join('_');
            
            db.collection("privateChats").doc(chatId).collection("messages")
                .orderBy("timestamp", "asc")
                .onSnapshot(snapshot => {
                    messagesContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        displayPrivateMessage(message);
                    });
                    // Scroll vers le bas
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
        }

        function displayPrivateMessage(message) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            
            messageElement.className = `message ${message.sender === currentUserEmail ? 'sent' : 'received'}`;
            messageElement.innerHTML = `
                <div class="message-info">
                    <span>${message.sender === currentUserEmail ? 'Vous' : message.sender}</span>
                    <span>${formatDate(message.timestamp)}</span>
                </div>
                <div>${message.text}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
        }

        function sendPrivateMessage() {
            if (!currentChatWith) return;
            
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            // Cr√©e un ID de conversation unique bas√© sur les emails tri√©s
            const chatId = [currentUserEmail, currentChatWith].sort().join('_');
            
            const messageData = {
                text: text,
                sender: currentUserEmail,
                recipient: currentChatWith,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection("privateChats").doc(chatId).collection("messages").add(messageData)
                .then(() => {
                    input.value = '';
                })
                .catch(error => {
                    console.error("Erreur lors de l'envoi du message: ", error);
                    alert("Une erreur est survenue lors de l'envoi du message");
                });
        }

        // Gestion du statut en ligne/hors ligne
        function managePresence() {
            const uid = auth.currentUser.uid;
            currentUserEmail = auth.currentUser.email;
            
            // R√©f√©rence √† la connexion Firestore
            const dbRef = db.collection("status").doc(currentUserEmail);
            
            // R√©f√©rence √† la connexion Firestore
            const isOfflineForFirestore = {
                state: 'offline',
                lastChanged: firebase.firestore.FieldValue.serverTimestamp(),
            };

            const isOnlineForFirestore = {
                state: 'online',
                lastChanged: firebase.firestore.FieldValue.serverTimestamp(),
            };

            // Surveille la connexion
            db.enableNetwork().then(() => {
                firebase.firestore().runTransaction(() => {
                    return dbRef.set(isOnlineForFirestore);
                });
                
                // D√©finit l'utilisateur comme hors ligne lorsqu'il se d√©connecte
                userStatusRef = dbRef.onSnapshot(() => {});
                
                // D√©finit l'utilisateur comme hors ligne lorsqu'il se d√©connecte
                auth.onAuthStateChanged((user) => {
                    if (!user) {
                        dbRef.set(isOfflineForFirestore);
                        if (userStatusRef) userStatusRef();
                    }
                });
                
                // D√©finit l'utilisateur comme hors ligne lorsque la fen√™tre se ferme
                window.addEventListener('beforeunload', () => {
                    dbRef.set(isOfflineForFirestore);
                });
            });
        }

        // ===== GESTION DE L'√âTAT =====
        auth.onAuthStateChanged(user => {
            const statusElement = document.getElementById('user-status');
            const authForms = document.getElementById('auth-forms');
            const commentsSection = document.getElementById('comments-section');
            const privateChatSection = document.getElementById('private-chat-section');
            
            if (user) {
                statusElement.innerHTML = `
                    <i class="fas fa-user-circle"></i> Connect√© en tant que <strong>${user.email}</strong> | 
                    <a href="#" onclick="signOut()"><i class="fas fa-sign-out-alt"></i> D√©connexion</a>
                `;
                authForms.classList.add('hidden');
                commentsSection.classList.remove('hidden');
                privateChatSection.classList.remove('hidden');
                loadComments();
                loadOnlineUsers();
                managePresence();
            } else {
                statusElement.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> Vous n'√™tes pas connect√©. 
                    Inscrivez-vous ou connectez-vous pour participer aux discussions.
                `;
                authForms.classList.remove('hidden');
                commentsSection.classList.add('hidden');
                privateChatSection.classList.add('hidden');
            }
        });

        // Permet d'envoyer un message avec la touche Entr√©e
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendPrivateMessage();
            }
        });
    </script>
</body>
</html>
