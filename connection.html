<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salon Eso-Botanica ðŸŒ¿</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- Font Awesome pour les icÃ´nes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4a6f28;
            --secondary: #8ba888;
            --light: #f1f8e9;
            --dark: #2c3e50;
            --accent: #e67e22;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
            color: var(--dark);
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        h2 {
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 8px;
            margin-top: 30px;
        }
        /* Section Authentification */
        .auth-forms {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .auth-form {
            flex: 1;
            min-width: 280px;
            padding: 25px;
            background: var(--light);
            border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        input:focus {
            border-color: var(--primary);
            outline: none;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s, transform 0.2s;
        }
        button:hover {
            background: #3a5a20;
            transform: translateY(-2px);
        }
        button.secondary {
            background: var(--secondary);
        }
        /* Section Utilisateur */
        #user-status {
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 500;
        }
        #user-status a {
            color: var(--accent);
            text-decoration: none;
            font-weight: bold;
        }
        /* Section Commentaires */
        #comments-section {
            margin-top: 40px;
        }
        .comments-container {
            margin-top: 20px;
        }
        .comment {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .comment-author {
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .comment-author i {
            color: var(--accent);
        }
        .comment-timestamp {
            font-size: 0.8rem;
            color: #777;
            margin-left: 10px;
        }
        .comment-text {
            margin: 15px 0;
            padding-left: 10px;
            border-left: 3px solid var(--secondary);
        }
        .comment-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .comment-actions button {
            padding: 6px 12px;
            font-size: 0.9rem;
            background: transparent;
            color: var(--dark);
            border: 1px solid #ddd;
        }
        .comment-actions button:hover {
            background: var(--light);
        }
        .comment-actions button.liked {
            color: #e74c3c;
        }
        .comment-actions button.liked i {
            color: #e74c3c;
        }
        .reply-form {
            margin-top: 15px;
            padding-left: 30px;
            border-left: 2px dashed var(--secondary);
        }
        .replies-container {
            margin-top: 20px;
            padding-left: 30px;
        }
        .reply {
            background: #f9f9f9;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }
        /* Formulaire principal */
        #comment-form {
            background: var(--light);
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
        }
        #comment-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
        }
        /* Messagerie privÃ©e */
        #private-messages-section {
            margin-top: 40px;
            display: none;
        }
        #pm-toggle {
            margin-bottom: 20px;
        }
        .pm-container {
            display: flex;
            gap: 20px;
        }
        #pm-users-list {
            flex: 1;
            max-width: 250px;
            background: var(--light);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .pm-user {
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .pm-user:hover {
            background: #e0e0e0;
        }
        .pm-user.active {
            background: var(--secondary);
            color: white;
        }
        #pm-conversation {
            flex: 3;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }
        #pm-messages {
            height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .pm-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            max-width: 70%;
        }
        .pm-message.sent {
            background: #e3f2fd;
            margin-left: auto;
        }
        .pm-message.received {
            background: #f1f1f1;
            margin-right: auto;
        }
        .pm-message-author {
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 3px;
        }
        .pm-message-time {
            font-size: 0.7rem;
            color: #777;
            text-align: right;
        }
        #pm-form {
            display: flex;
            gap: 10px;
        }
        #pm-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /* Classes utilitaires */
        .hidden {
            display: none !important;
        }
        .text-center {
            text-align: center;
        }
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .comment, .reply, .pm-message {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-leaf"></i>Eso-Forum</h1>
        
        <!-- Ã‰tat de connexion -->
        <div id="user-status">Chargement...</div>

        <!-- Formulaires Auth -->
        <div class="auth-forms" id="auth-forms">
            <div class="auth-form">
                <h2><i class="fas fa-user-plus"></i> Inscription</h2>
                <input type="email" id="signup-email" placeholder="Votre email">
                <input type="password" id="signup-password" placeholder="Mot de passe (6+ caractÃ¨res)">
                <button onclick="signUp()"><i class="fas fa-user-edit"></i> S'inscrire</button>
            </div>
            <div class="auth-form">
                <h2><i class="fas fa-sign-in-alt"></i> Connexion</h2>
                <input type="email" id="login-email" placeholder="Votre email">
                <input type="password" id="login-password" placeholder="Mot de passe">
                <button onclick="signIn()"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
            </div>
        </div>

        <!-- Section Commentaires -->
        <div id="comments-section" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2><i class="fas fa-comments"></i> Discussions</h2>
                <button id="pm-toggle" onclick="togglePrivateMessages()">
                    <i class="fas fa-envelope"></i> Messages privÃ©s
                </button>
            </div>
            <div id="comments-container" class="comments-container"></div>
            
            <form id="comment-form">
                <h3><i class="fas fa-edit"></i> Nouveau commentaire</h3>
                <textarea id="comment-input" placeholder="Partagez vos connaissances en botanique Ã©sotÃ©rique..."></textarea>
                <button type="button" onclick="postComment()"><i class="fas fa-paper-plane"></i> Publier</button>
            </form>
        </div>

        <!-- Section Messagerie privÃ©e -->
        <div id="private-messages-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2><i class="fas fa-envelope"></i> Messages privÃ©s</h2>
                <button id="pm-toggle" onclick="togglePrivateMessages()">
                    <i class="fas fa-comments"></i> Retour aux discussions
                </button>
            </div>
            
            <div class="pm-container">
                <div id="pm-users-list">
                    <h3>Utilisateurs</h3>
                    <div id="pm-users"></div>
                </div>
                
                <div id="pm-conversation">
                    <div id="pm-messages"></div>
                    <form id="pm-form" onsubmit="sendPrivateMessage(); return false;">
                        <input type="text" id="pm-input" placeholder="Ã‰crivez votre message...">
                        <button type="submit"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBdVFpZ5xwM90QZMIMC9m8jrTaLNqN_bI4",
            authDomain: "connection-5392f.firebaseapp.com",
            projectId: "connection-5392f",
            storageBucket: "connection-5392f.appspot.com",
            messagingSenderId: "157508792872",
            appId: "1:157508792872:web:23987228dfa3facf627b1d"
        };

        // Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables globales
        let currentReplyTo = null;
        let currentPmRecipient = null;
        let users = [];

        // ===== AUTHENTIFICATION =====
        function signUp() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    alert("Bienvenue dans la communautÃ© Eso-Botanica !");
                })
                .catch(error => {
                    alert("Erreur: " + error.message);
                });
        }

        function signIn() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    console.log("Connexion rÃ©ussie");
                })
                .catch(error => {
                    alert("Erreur: " + error.message);
                });
        }

        function signOut() {
            auth.signOut();
            currentReplyTo = null;
            currentPmRecipient = null;
        }

        // ===== GESTION DES COMMENTAIRES =====
        async function postComment() {
            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();
            
            if (!commentText) return;
            
            try {
                if (currentReplyTo) {
                    // Poste une rÃ©ponse
                    const replyData = {
                        text: commentText,
                        author: auth.currentUser.email,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        parentId: currentReplyTo
                    };
                    
                    await db.collection("comments").doc(currentReplyTo).collection("replies").add(replyData);
                    
                    commentInput.value = "";
                    commentInput.placeholder = "Partagez vos connaissances en botanique Ã©sotÃ©rique...";
                    currentReplyTo = null;
                } else {
                    // Poste un nouveau commentaire principal
                    const commentData = {
                        text: commentText,
                        author: auth.currentUser.email,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        likes: 0,
                        likedBy: []
                    };
                    
                    await db.collection("comments").add(commentData);
                    commentInput.value = "";
                }
            } catch (error) {
                console.error("Erreur lors de la publication: ", error);
                alert("Une erreur est survenue lors de la publication");
            }
        }

        function replyToComment(commentId, author) {
            currentReplyTo = commentId;
            const commentInput = document.getElementById('comment-input');
            commentInput.placeholder = `RÃ©ponse Ã  ${author}...`;
            commentInput.focus();
        }

        function toggleLike(commentId, currentLikes, likedBy) {
            if (!auth.currentUser) return;
            
            const userId = auth.currentUser.uid;
            const userEmail = auth.currentUser.email;
            const commentRef = db.collection("comments").doc(commentId);
            
            // VÃ©rifie si l'utilisateur a dÃ©jÃ  likÃ©
            const userIndex = likedBy.indexOf(userEmail);
            let newLikes = currentLikes;
            let newLikedBy = [...likedBy];
            
            if (userIndex > -1) {
                // Retire le like
                newLikes--;
                newLikedBy.splice(userIndex, 1);
            } else {
                // Ajoute un like
                newLikes++;
                newLikedBy.push(userEmail);
            }
            
            // Met Ã  jour le commentaire
            commentRef.update({
                likes: newLikes,
                likedBy: newLikedBy
            }).catch(error => {
                console.error("Erreur lors de la mise Ã  jour du like: ", error);
            });
        }

        // ===== AFFICHAGE DES COMMENTAIRES =====
        function loadComments() {
            // Ã‰coute les commentaires principaux
            db.collection("comments")
                .orderBy("timestamp", "desc")
                .onSnapshot(snapshot => {
                    const container = document.getElementById('comments-container');
                    container.innerHTML = "";
                    
                    snapshot.forEach(doc => {
                        const comment = doc.data();
                        displayComment(doc.id, comment, container);
                        
                        // Charge les rÃ©ponses existantes
                        loadReplies(doc.id);
                    });
                }, error => {
                    console.error("Erreur lors du chargement des commentaires: ", error);
                });
        }

        function loadReplies(commentId) {
            db.collection("comments").doc(commentId).collection("replies")
                .orderBy("timestamp")
                .onSnapshot(snapshot => {
                    const repliesContainer = document.getElementById(`replies-${commentId}`);
                    if (repliesContainer) {
                        repliesContainer.innerHTML = "";
                        snapshot.forEach(replyDoc => {
                            const reply = replyDoc.data();
                            displayReply(reply, repliesContainer);
                        });
                    }
                }, error => {
                    console.error("Erreur lors du chargement des rÃ©ponses: ", error);
                });
        }

        function displayComment(id, comment, container) {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            commentElement.id = `comment-${id}`;
            
            const isLiked = auth.currentUser && comment.likedBy && comment.likedBy.includes(auth.currentUser.email);
            
            commentElement.innerHTML = `
                <div class="comment-author">
                    <i class="fas fa-user"></i>
                    ${comment.author}
                    <span class="comment-timestamp">${formatDate(comment.timestamp)}</span>
                </div>
                <div class="comment-text">${comment.text}</div>
                <div class="comment-actions">
                    <button onclick="toggleLike('${id}', ${comment.likes || 0}, ${JSON.stringify(comment.likedBy || [])})" 
                            class="${isLiked ? 'liked' : ''}">
                        <i class="fas fa-heart"></i> J'aime (${comment.likes || 0})
                    </button>
                    <button onclick="replyToComment('${id}', '${comment.author}')">
                        <i class="fas fa-reply"></i> RÃ©pondre
                    </button>
                    ${comment.author !== auth.currentUser.email ? 
                      `<button onclick="startPrivateMessage('${comment.author}')">
                        <i class="fas fa-envelope"></i> Message privÃ©
                      </button>` : ''}
                </div>
                <div id="replies-${id}" class="replies-container"></div>
            `;
            container.appendChild(commentElement);
        }

        function displayReply(reply, container) {
            const replyElement = document.createElement('div');
            replyElement.className = 'reply';
            replyElement.innerHTML = `
                <div class="comment-author">
                    <i class="fas fa-user"></i>
                    ${reply.author}
                    <span class="comment-timestamp">${formatDate(reply.timestamp)}</span>
                </div>
                <div class="comment-text">${reply.text}</div>
            `;
            container.appendChild(replyElement);
        }

        // ===== MESSAGERIE PRIVÃ‰E =====
        function togglePrivateMessages() {
            const commentsSection = document.getElementById('comments-section');
            const pmSection = document.getElementById('private-messages-section');
            
            if (pmSection.style.display === 'none' || !pmSection.style.display) {
                commentsSection.style.display = 'none';
                pmSection.style.display = 'block';
                loadUsersForPM();
            } else {
                commentsSection.style.display = 'block';
                pmSection.style.display = 'none';
            }
        }

        function loadUsersForPM() {
            // Charger tous les utilisateurs qui ont postÃ© des commentaires
            db.collection("comments")
                .get()
                .then(snapshot => {
                    const usersSet = new Set();
                    snapshot.forEach(doc => {
                        const comment = doc.data();
                        if (comment.author !== auth.currentUser.email) {
                            usersSet.add(comment.author);
                        }
                    });
                    
                    // Ajouter aussi les utilisateurs qui ont envoyÃ©/reÃ§u des messages
                    db.collection("privateMessages")
                        .where("participants", "array-contains", auth.currentUser.email)
                        .get()
                        .then(pmSnapshot => {
                            pmSnapshot.forEach(doc => {
                                const pm = doc.data();
                                pm.participants.forEach(email => {
                                    if (email !== auth.currentUser.email) {
                                        usersSet.add(email);
                                    }
                                });
                            });
                            
                            // Afficher la liste des utilisateurs
                            const usersList = document.getElementById('pm-users');
                            usersList.innerHTML = '';
                            
                            users = Array.from(usersSet).sort();
                            users.forEach(user => {
                                const userElement = document.createElement('div');
                                userElement.className = 'pm-user';
                                userElement.textContent = user;
                                userElement.onclick = () => loadPrivateMessages(user);
                                usersList.appendChild(userElement);
                            });
                        });
                })
                .catch(error => {
                    console.error("Erreur lors du chargement des utilisateurs: ", error);
                });
        }

        function startPrivateMessage(email) {
            togglePrivateMessages();
            loadPrivateMessages(email);
        }

        function loadPrivateMessages(recipientEmail) {
            currentPmRecipient = recipientEmail;
            
            // Mettre en surbrillance l'utilisateur sÃ©lectionnÃ©
            const userElements = document.querySelectorAll('.pm-user');
            userElements.forEach(el => {
                if (el.textContent === recipientEmail) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
            
            // Charger les messages avec cet utilisateur
            db.collection("privateMessages")
                .where("participants", "array-contains", auth.currentUser.email)
                .orderBy("lastUpdated", "desc")
                .get()
                .then(snapshot => {
                    let conversationId = null;
                    const messagesContainer = document.getElementById('pm-messages');
                    messagesContainer.innerHTML = '';
                    
                    // Trouver la conversation avec ce destinataire
                    snapshot.forEach(doc => {
                        const pm = doc.data();
                        if (pm.participants.includes(recipientEmail)) {
                            conversationId = doc.id;
                            
                            // Charger les messages de cette conversation
                            db.collection("privateMessages").doc(doc.id).collection("messages")
                                .orderBy("timestamp")
                                .onSnapshot(messagesSnapshot => {
                                    messagesContainer.innerHTML = '';
                                    messagesSnapshot.forEach(msgDoc => {
                                        const message = msgDoc.data();
                                        displayPrivateMessage(message);
                                    });
                                    
                                    // Faire dÃ©filer vers le bas
                                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                });
                        }
                    });
                    
                    // Si aucune conversation existante, crÃ©er un nouvel ID
                    if (!conversationId) {
                        conversationId = db.collection("privateMessages").doc().id;
                        db.collection("privateMessages").doc(conversationId).set({
                            participants: [auth.currentUser.email, recipientEmail],
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    // Mettre Ã  jour le formulaire pour envoyer Ã  cette conversation
                    document.getElementById('pm-form').dataset.conversationId = conversationId;
                });
        }

        function displayPrivateMessage(message) {
            const messagesContainer = document.getElementById('pm-messages');
            const messageElement = document.createElement('div');
            
            messageElement.className = `pm-message ${message.sender === auth.currentUser.email ? 'sent' : 'received'}`;
            messageElement.innerHTML = `
                <div class="pm-message-author">${message.sender === auth.currentUser.email ? 'Vous' : message.sender}</div>
                <div>${message.text}</div>
                <div class="pm-message-time">${formatDate(message.timestamp)}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
        }

        function sendPrivateMessage() {
            const input = document.getElementById('pm-input');
            const text = input.value.trim();
            const conversationId = document.getElementById('pm-form').dataset.conversationId;
            
            if (!text || !conversationId || !currentPmRecipient) return;
            
            db.collection("privateMessages").doc(conversationId).collection("messages").add({
                sender: auth.currentUser.email,
                recipient: currentPmRecipient,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                // Mettre Ã  jour la date de derniÃ¨re modification de la conversation
                db.collection("privateMessages").doc(conversationId).update({
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                input.value = '';
            }).catch(error => {
                console.error("Erreur lors de l'envoi du message: ", error);
                alert("Une erreur est survenue lors de l'envoi du message");
            });
        }

        // ===== UTILITAIRES =====
        function formatDate(timestamp) {
            if (!timestamp) return "maintenant";
            const date = timestamp.toDate();
            return date.toLocaleString('fr-FR', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ===== GESTION DE L'Ã‰TAT =====
        auth.onAuthStateChanged(user => {
            const statusElement = document.getElementById('user-status');
            const authForms = document.getElementById('auth-forms');
            const commentsSection = document.getElementById('comments-section');
            const pmSection = document.getElementById('private-messages-section');
            
            if (user) {
                statusElement.innerHTML = `
                    <i class="fas fa-user-circle"></i> ConnectÃ© en tant que <strong>${user.email}</strong> | 
                    <a href="#" onclick="signOut()"><i class="fas fa-sign-out-alt"></i> DÃ©connexion</a>
                `;
                authForms.classList.add('hidden');
                commentsSection.classList.remove('hidden');
                pmSection.style.display = 'none';
                loadComments();
            } else {
                statusElement.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> Vous n'Ãªtes pas connectÃ©. 
                    Inscrivez-vous ou connectez-vous pour participer aux discussions.
                `;
                authForms.classList.remove('hidden');
                commentsSection.classList.add('hidden');
                pmSection.style.display = 'none';
                currentPmRecipient = null;
            }
        });
    </script>
</body>
</html>
